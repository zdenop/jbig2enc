name: Msys2

on:
  push:
    paths:
      - src/**
      - .github/**
      - configure.ac
      - Makefile.am
  pull_request:
  workflow_dispatch:

jobs:

  build:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - { icon: 'üü¶', sys: mingw64 }
          # - { icon: 'üü®', sys: ucrt64  }
          # - { icon: '‚¨õ', sys: mingw32 }  error: target not found: mingw-w64-i686-leptonica
    name: üêú${{ matrix.icon }} ${{ matrix.sys }}
    defaults:
      run:
        shell: msys2 {0}
    steps:

    - name: 'üß∞ Checkout'
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        persist-credentials: false

    - name: '${{ matrix.icon }} Setup MSYS2'
      uses: msys2/setup-msys2@v2
      with:
        msystem: ${{matrix.sys}}
        update: true
        install: >-
          git
          make
          autoconf
          automake
          libtool
          python3
          pkg-config
          zip
          objdump
        pacboy: >-
          zlib:x
          leptonica:p
          gcc:p

    - name: 'Ô∏è#Ô∏è‚É£ get-hash'
      id: hash
      run: echo "sha_short=$(git describe --tags)" >> $GITHUB_OUTPUT
      # run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      # run: echo "::set-output name=sha_short::$(git rev-parse --short HEAD)"

    - name: 'üîß Configure jbig2enc'
      run: |
           ./autogen.sh
           ./configure '--disable-shared' 'CXXFLAGS=-g -O2 -static'
           # ./configure '--disable-shared' 'CXXFLAGS=-g -O2'

    - name: 'üöß Build and install jbig2enc'
      run: |
           # make LDFLAGS="-all-static"
           make
           make install

    - name: '‚ÑπÔ∏è Display version'
      run: |
           jbig2 -V

    - name: 'üèÉ Run test'
      run: |
           jbig2 -a -p -v images/feyn.tif > feyn.jb2
           python3 jbig2topdf.py -s feyn.jb2 > feyn.pdf

    - name: 'üçÉ List files in the repository'
      run: |
           # ls -lR
           # find /c/ -name "libstdc++-6.dll"
           # find /c/ -name "libgcc_s_seh-1.dll"
           # find /c/ -name "libleptonica-6.dll"
           # ls -lR ${{ github.workspace }}
           # dir /?
           # dir /S
           ls -lR /${{matrix.sys}}/bin/*.dll
           objdump -p src/jbig2.exe | grep "DLL Name:"

    - name: 'üì¶ Make zip'
      run: |
        name=jbig2enc_${{ steps.hash.outputs.sha_short }}-${{matrix.sys}}
        mkdir $name
        cp jbig2topdf.py src/jbig2.exe $name/
        # cp /usr/bin/msys-2.0.dll $name/
        cp /${{matrix.sys}}/bin/libstdc++-6.dll $name/
        cp /${{matrix.sys}}/bin/libgcc_s_seh-1.dll $name/
        cp /${{matrix.sys}}/bin/libleptonica-6.dll $name/
        cp /${{matrix.sys}}/bin/libpng16-16.dll $name/
        cp /${{matrix.sys}}/bin/libwebp-7.dll $name/
        cp /${{matrix.sys}}/bin/libtiff-6.dll $name/
        cp /${{matrix.sys}}/bin/libjpeg-8.dll $name/
        cp /${{matrix.sys}}/bin/libwebpmux-3.dll $name/
        cp /${{matrix.sys}}/bin/libwinpthread-1.dll $name/
        cp /${{matrix.sys}}/bin/libsharpyuv-0.dll $name/
        cp /${{matrix.sys}}/bin/libgif-7.dll $name/
        cp /${{matrix.sys}}/bin/libopenjp2-7.dll $name/
        cp /${{matrix.sys}}/bin/libdeflate.dll $name/
        cp /${{matrix.sys}}/bin/libjbig-0.dll $name/
        cp /${{matrix.sys}}/bin/zlib1.dll $name/
        cp /${{matrix.sys}}/lib/libjbig2enc.la $name/
        cp /${{matrix.sys}}/lib/libjbig2enc.a $name/
        cp AUTHORS ChangeLog COPYING INSTALL NEWS README.md $name/
        zip -r $name.zip $name/
    - name: '‚è´ Upload Build Results'
      uses: actions/upload-artifact@v4
      with:
        name: jbig2enc_${{ steps.hash.outputs.sha_short }}-${{matrix.sys}}
        path: jbig2enc_${{ steps.hash.outputs.sha_short }}-${{matrix.sys}}.zip
        retention-days: 5